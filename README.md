Проект по классификации свободных мест в автобусе при помощи интегрирования машинного зрения (Computer Vision) в камеры внутри автобуса был создан для удобства пассажиров, желающих воспользоваться конкретным автобусом. Данные с модели будут отправляться в приложение, в котором можно отслеживать передвижение автобусов онлайн (пример такого приложения – Яндекс карты). В приложении будет указано количество свободных мест в автобусе в данный момент времени.

Цели проекта:
1)	Обеспечить пассажиров возможностью ознакомиться с количеством свободных мест до посадки в автобус
2)	Создать прототип продукта

Задачи проекта:
1)   Собрать обучающую выборку для будущей модели (порядка изображений)
2)   Разработать модель, которая с достаточной точностью (выше 85%) сможет классифицировать свободные и занятые места в автобусе на потоковом видео (аналог прямой трансляции с камеры)
3)   Смоделировать макет приложения для отображения информации о свободных местах в автобусе
4)    Собрать статистику об актуальности проекта, о целевой аудитории посредством опроса людей разных возрастных групп
5) Провести анализ собранной статистики и визуализировать ее с помощью графиков

Когда задачи и цели были выдвинуты, мы начали подбирать инструменты для их выполнения:
Supervisely – разметка изображений для датасета
PyCharm – обучение модели
Android Studio – разработка мобильного приложения

Сбор статистики

Источники данных
Статистика актуальности идеи нашего проекта собиралась среди разных социальных групп (школьники, студенты, взрослые).  Сбор статистики осуществлялся посредством опроса людей в соцсетях и знакомых. Всего было опрошено порядка 80 человек.

Сервис обработки данных
В качестве сервиса для обработки данных мы выбрали Google Forms, т.к. он обладает большим функционалам по сравнению с конкурентами и более удобен в использовании.

Анализ результатов
Для анализа результатов мы создали диаграммы на основе полученной статистики. В ходе анализа выяснили что тема действительно актуальна (22% порошенных пользуются общественным транспортом ежедневно, 30% несколько раз в неделю, 37% часто пользуются картами с отображением автобусов онлайн, 18.3% не очень часто, 91% считают полезной возможность знать заранее, есть ли в автобусе свободные места)

 
Постановка задачи

Идея приложения: подсчёт свободных мест в автобусе  
Изначально мы думали делать исследование. Темы для исследований были такими: Влияние режима сна на успеваемость студентов, Связь между вейпингом и качеством сна, Частота употребления энергетиков во время сессии, Распространенность вейпинга среди студентов разных курсов. Позже после уточнения того, что нужно делать у преподавателя, мы приняли решение делать проект на основе машинного зрения. Было так же несколько тем, из которых мы выбирали: Детекция и классификация повреждений на автомобилях для страховых компаний, Система распознавания эмоций в реальном времени для улучшения сервиса в ритейле, Распознавание поддельных документов на основе анализа текстур и водяных знаков, Система контроля качества продуктов на конвейере (например, фруктов/овощей), Поиск потерянных предметов в общественных местах на основе запросов в NLP + CV, Оптимизация парковок через детекцию свободных мест в реальном времени, Система распознавания модификаций тела (татуировки, шрамы) для криминалистики. Посидев и проанализировав что, мы реально сможем реализовать и что будет полезно мы придумали идею определения свободных мест в автобусе по камерам. Мы посчитали что это не невозможно реализовать с нашими данными и будет полезно обществу.
 
Особенности работы в реальном времени  
Так как мы не имеем прямого доступа к камерам для тестирования и демонстрирования модели используются зацикленные видео из салонов автобусов.


Поиск и анализ датасетов

Отсутствие готовых подходящих датасетов
После утверждения окончательной идеи проекта начался сбор данных по теме. В интернете были найдены такие датасеты как: Historic Bus Occupancy Data и Dataset for Advanced Public Transportation System under Limited Infrastructure Support в которых нет напрямую данных с камер, а лишь количество людей и траектории автобусов; TICaM Dataset (Time-of-flight In-car Cabin Monitoring) и Data Light Dataset, которые содержат либо салоны транспортных средств, не включающих автобусы, либо просто фотографии городской среды включая автобусы. Ни один из вариантов не подходил для реализации нашего проекта, поэтому было принято решение собирать датасет вручную на 1000+ фотографий. 

Ручная сборка собственного датасета
Датасет собирался из различных источников таких как istock.com для фотографий и youtube.com, tiktok.com и vk.com для нахождения более-менее подходящих видео. После нахождения подходящих видео они разбивались на кадры и далее обрабатывались как фотографии. Так же некоторые видео использовались как тестовые для проверки работоспособности модели.

Используемые инструменты
Изначально думали делать разметку через Labelimg в Phyton, но в интернете Миша нашел supervisely dashboard. На этом сайте можно добавлять фотографии в датасет, объединять отдельные датасеты и работать над проектом в команде, поэтому данный сервис лучше всего подошёл под наши задачи и именно в нем был размечен весь наш датасет. Пример разметки supervisely:
 
Обучение модели YOLOv8
Мы обучали нашу модель на архитектуре YOLOv8, так как по сравнению с R-cnn или ssd yolo имеет большую скорость работы, при этом не теряя точность. К тому же такая архитектура подходит для обработки в реальном времени, что идеально для нашего проекта. Работа осуществлялась в Google Colab. Вот код, который использовался для обучения модели на том этапе:
 

Так как при экспорте из supervisely папки val не было, в коде есть функция if len(os.listdir(val_images_path)) == 0, которая сначала проверяет наличие валидационных данных, и если их нет (0) начинает перемещение 10% из папки для обучения. В начале у модели было 50 эпох и батч 16, но экспериментальным путём были выявлены актуальные значения. Такие гиперпараметры для модели были выбраны для максимально оптимального обучения. Батч 32 был выбран так как обучение происходило на gpu, и мы могли позволить большее потребление производительности при обучении. Остальные гиперпараметры выбирались автоматическим подбором YOLO, что позволило подобрать оптимальные значения без затрат времени и ресурсов. 
Для тестирования модели в colab после обучения был использован следующий код:
 
Данный код позволяет циклично обрабатывать фото или видео, с выводом результатов.

Проблемы с распаковкой в Colab
Датасет их supervisely экспортировался архивом .zip. При обычной разархивации в colab выдавалась ошибка, что такого архива не существует. После нескольких попыток исправления было выяснено что colab вообще не видит содержимое архива, поэтому было принято решение вручную создавать каждую папку из архива, и перемещать туда фотографии. С каждым разом архив сбрасывался, что очень неудобно для оптимальной работы, поэтому мы попробовали сохранить датасет в google drive, но проблему это не решило. Спустя какое-то время было принято решение переходить на локальный интерпретатор python (PyCharm Community).
Успешный запуск обучения
После некоторых успешных запусков обучения модели в google colab работа была продолжена локально в PyCharm. Код из colab был адаптирован для локального интерпретатора:

Выбор best.pt
Наша лучшая модель была обучена на 50 эпохах и батчем 16. Так же были протестированы модели с 20,50,55,80,100 эпохами, с батчем 32. У моделей на 80 эпох так же были протестированы различные clr (уверенность), но значения по умолчанию оказались самыми оптимальными.
Во время обучения модели YOLOv8 мы отслеживали несколько ключевых метрик и функций потерь, представленных на итоговом графике. Каждая из этих метрик играет важную роль в понимании того, насколько хорошо обучается нейросеть и насколько точно она способна распознавать объекты.
Функции потерь (loss) делятся на несколько типов. train/box_loss и val/box_loss отражают ошибку локализации – то, насколько точно модель определяет координаты ограничивающих рамок на тренировочном и валидационном наборах соответственно. Аналогично, train/cls_loss и val/cls_loss показывают, насколько точно модель классифицирует объекты в рамке. Кроме того, YOLOv8 использует продвинутую функцию потерь dfl_loss (Distribution Focal Loss), которая помогает более точно определять границы объектов — её также видно в виде train/dfl_loss и val/dfl_loss.
Оценка качества модели
Метрики качества оценки включают precision, recall и mAP. Precision (точность) отражает долю правильно предсказанных объектов среди всех предсказаний модели. Recall (полнота) показывает, сколько из всех реальных объектов модель смогла обнаружить. Самой важной сводной метрикой является mAP (mean Average Precision). На графике отображены mAP50 (точность при IOU ≥ 0.5) и mAP50-95 (точность при IOU от 0.5 до 0.95 с шагом 0.05), где последняя считается наиболее строгой и надёжной оценкой качества.
На всех графиках наблюдается стабильное снижение значений функций потерь и рост метрик точности. Это указывает на то, что обучение проходило корректно, без признаков переобучения: нет резких скачков или расхождений между обучающей и валидационной выборками. Значения precision достигают приблизительно 0.8, recall — около 0.65, mAP50 — до 0.75, а mAP50-95 — до 0.40, что является достаточно хорошими результатами для наших задач. Обучение модели завершилось успешно, и финальный результат говорит о том, что модель работает должным образом.
Вывод графиков mAP, precision/recall  
 

Выводы и дальнейшие шаги

Результаты  
В ходе проекта была успешно разработана и реализована система детекции свободных мест в автобусе с использованием нейросетевой модели YOLOv8 и мобильного приложения на Android. Полученные результаты демонстрируют работоспособность концепции и достижение поставленных целей.

Потенциал проекта и возможности доработки
Хотя проект уже выполняет свои базовые задачи, у него есть значительный потенциал для дальнейшего расширения и улучшения, как в части модели, так и интерфейса. Датасет при желании можно масштабировать на порядки, а модель может использоваться в любом виде автобусов.

Таким образом, проект продемонстрировал практическую реализацию компьютерного зрения и мобильных технологий на современном уровне. Он обладает гибкой архитектурой, что делает возможным его доработку под любые задачи, связанные с анализом сцены и детекцией объектов в кадре.
С учётом скорости обработки, компактности модели и визуального интерфейса, система может быть внедрена в реальные автобусы и приложения.




